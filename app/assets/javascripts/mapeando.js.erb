
  //var map = new google.maps.Map(document.getElementById('map'));
  var area = [];
  var markersCount = 0;
  markers = [];
  var poligonoArea;
  var dibujado = false;
  var handler = Gmaps.build('Google');
  var zoom = 13;// zoom del mapa 
  var areas = [];

//position central del mapa
function positionCenter(pos, items){
  var latlng;
  if (pos ==2){
   
    latlng ={lat: items[0].lat, lng: items[0].lng};
    zoom=15;

  }else{
     latlng = {lat: -27.367193930439235, lng: -55.893094539642334};
  }
  return latlng;
}


function createMap(items, vista){
  // var handler = Gmaps.build('Google');

  
  handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
    markers = handler.addMarkers(items);
    handler.bounds.extendWith(markers);
    handler.getMap().setCenter(positionCenter(vista, items));// centra el mapa en lng lat
    handler.getMap().setZoom(zoom);// zoom map x veces
    //handler.fitMapToBounds();

      google.maps.event.addListener(handler.getMap(), 'click', function( event ){
       console.log("toc toc");

            if (dibujado ==  false) {
              area.push({ lat: event.latLng.lat(), lng: event.latLng.lng() });

               var newlatlng = { lat: event.latLng.lat(), lng: event.latLng.lng() };
               console.log(newlatlng);
                  var newmarker  = handler.addMarkers(
                [
                  {
                    "lng": event.latLng.lng(),
                    "lat": event.latLng.lat(),
                  }
                ]
              ,{ draggable: true}
              );

              //markers = handler.addMarkers(items ,{ draggable: true})
              markers[markersCount] = newmarker;
              markersCount += 1;
            } else {
              alert("Ups! Ya se encuentra creada la zona. Eliminela para volver a dibujar.");
            }
      });
  });
}



document.addEventListener("turbolinks:load", function() {

    $("#go").click(function(){
			   // alert("The button was clicked.");
         var nombre_zona = document.getElementById('zone_nombre_zona').value;
			   var color = document.getElementById('zone_color').value;
         
         $.ajax({
				   url: "/zones/create",
				   type: "POST",
				   data: {
            "nombre_zona":nombre_zona,
            "color":color,
            "area": area},
				   dataType: "json",
				   success: function(data) {

				      console.log(data);
				     }
				   });
   });


  $("#btnmarcar").click(function(){
    
    if (markersCount > 0 && dibujado == false) {
      
      poligonoArea = handler.addPolygons({
      // poligonoArea = new google.maps.Polygon({
        paths: area,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.35
      });

      if (area.lentgh < 1 || (markersCount > 2 && dibujado == false)) {
        //poligonoArea.setMap(map);
        handler.bounds.extendWith(poligonoArea);
        dibujado = true;
      }
    }

  });

});



// mapeando zonas

function createMapZone(items, vista){           
  
  handler.buildMap({ provider: {}, internal: {id: 'map_zone'}}, function(){
    markers = handler.addMarkers(items);
    handler.bounds.extendWith(markers);
    handler.getMap().setCenter(positionCenter(vista, items));// centra el mapa en lng lat
    handler.getMap().setZoom(zoom);// zoom map x veces
    //handler.fitMapToBounds();
      google.maps.event.addListener(handler.getMap(), 'click', function( event ){
       console.log("toc toc");

            if (dibujado ==  false) {
              area.push({ lat: event.latLng.lat(), lng: event.latLng.lng() });

               var newlatlng = { lat: event.latLng.lat(), lng: event.latLng.lng() };
               console.log(newlatlng);

                  var newmarker  = handler.addMarkers(
                [
                  {
                    "lng": event.latLng.lng(),
                    "lat": event.latLng.lat(),
                  }
                ]
              ,{ draggable: true}
              );
              markers[markersCount] = newmarker;
              markersCount += 1;
            } else {
              alert("Ups! Ya se encuentra creada la zona. Eliminela para volver a dibujar.");
            }
      });

  });
}


//mostrar tdas las zonas ************

function viewZonesAll(items, vista){
  handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
    // markers = handler.addMarkers(items);
    // handler.bounds.extendWith(markers);
    handler.getMap().setCenter(positionCenter(vista, items));// centra el mapa en lng lat
    handler.getMap().setZoom(zoom);// zoom map x veces

var areashow = [];
 var mizona = items[0].zone;
 
 for (var j = 0; j < items.length; j++){
    if (items[j].zone == mizona){
      areashow.push(items[j]);
    }else if (items[j].zone != undefined ){
      mizona = items[j].zone;
     
      //***** mostrar zona
      poligonoArea = handler.addPolygons({
        paths: areashow,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.35
      });
    handler.bounds.extendWith(poligonoArea);
    areas.push(poligonoArea);
    var areashow=[];
     areashow.push(items[j]);

    }
 }
if(j==items.length){
        poligonoArea = handler.addPolygons({
        paths: areashow,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.35
      });
    handler.bounds.extendWith(poligonoArea);

}
  
  });
}


//***************************************************************
//zone and markers
        function mapsMarkerZones(items,has_zone, vista){
        // var handler = Gmaps.build('Google');

        handler.buildMap({ provider: {gestureHandling: 'greedy'}, internal: {id: 'map'}}, function(){
        markers = handler.addMarkers(items);
        handler.bounds.extendWith(markers);
        handler.getMap().setCenter(positionCenter(vista, items));// centra el mapa en lng lat
        handler.getMap().setZoom(zoom);// zoom map x veces
        //handler.fitMapToBounds();

// for (var j = 0; j < items.length; j++){
//   var info = items[j].infowindow;
//   info = info.split("/", 1);
//   console.log( parseInt(info));
// }

        var areashow = [];
        var mizona = has_zone[0].zone;
        var zonaPoly = [];


        for (var j = 0; j < has_zone.length; j++){
        if (has_zone[j].zone == mizona){
        areashow.push(has_zone[j]);
        }else if (has_zone[j].zone != undefined ){
        mizona = has_zone[j].zone;

        //***** mostrar zona
        poligonoArea = handler.addPolygons({
        paths: areashow,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.35
        });
        handler.bounds.extendWith(poligonoArea);
        areas.push(poligonoArea);

        var areashow=[];
        areashow.push(has_zone[j]);

        }
        }

        if(j==has_zone.length){
        poligonoArea = handler.addPolygons({
        paths: areashow,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.35
        });
        handler.bounds.extendWith(poligonoArea);
        areas.push(poligonoArea);

        }


          var zonaSearch = new google.maps.Polygon({
            paths: areashow
          });

    for (var j = 0; j < items.length; j++){
        var coordinate = new google.maps.LatLng(items[j].lat, items[j].lng);//replace with your lat and lng values
        // console.log(coordinate);

        var isWithinPolygon = google.maps.geometry.poly.containsLocation(coordinate, zonaSearch)  ?
        'ADENTRO' :
        'AFUERA';
          var info = items[j].infowindow;
          info = info.split("/", 1);
          console.log( "El Cliente Numero "+ parseInt(info) + " se encuentra " + isWithinPolygon + " de la zona." );

  
    }



        //si el marker cae dentro del poligono ---> color rojo


        });
        }




